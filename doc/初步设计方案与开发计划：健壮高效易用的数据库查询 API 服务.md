# 初步设计方案与开发计划：健壮高效易用的数据库查询 API 服务

## 1. 引言

本文档基于先前输出的《项目需求分析概要》和《技术选型与架构建议》，旨在为“健壮高效易用的数据库查询 API 服务”项目提供一份初步的整合设计方案和阶段性开发计划。其目标是清晰地阐述项目将如何从概念走向实现，覆盖关键模块设计、技术实施路径、开发阶段划分及主要里程碑，为项目的顺利推进奠定基础。

## 2. 项目核心目标与范围回顾

项目致力于构建一个基于 Java 17+ 和 Spring Boot 3.x 的高质量后端 API 服务。核心使命是为前端应用及其他系统提供统一、高效、支持多目标数据库的查询能力。关键特性包括：元数据通过 MySQL/OceanBase 持久化管理，支持动态数据源接入（通过第三方 API 或本地元数据），内置静态 SQL 管理与批量执行，遵循 RESTful 的 API 设计，具备可视化调试前端，并能调用外部 REST API。非功能性方面，强调高性能（P95 < 300ms，≥ 500 QPS）、高可靠性（幂等、重试、熔断、限流）、安全性（HTTPS, OAuth2/JWT, SQL注入防护）、可扩展性（模块化, SPI, 配置中心）和可观测性（Prometheus, Grafana, Tracing, Logging）。

## 3. 技术架构总览

服务将采用分层架构，主要包括：
*   **API 接入层 (Controller Layer)**: 基于 Spring MVC，负责接收 HTTP 请求，进行初步参数校验，并将请求分发到服务层。使用 Springdoc OpenAPI 生成和暴露 API 文档。
*   **服务层 (Service Layer)**: 包含核心业务逻辑，如数据源动态管理、SQL 模板管理、SQL 执行编排、外部 API 调用封装等。
*   **数据访问层 (Data Access Layer)**: 
    *   **元数据访问**: 使用 Spring Data JPA 与 MySQL/OceanBase 交互，管理数据源配置、SQL 模板等元数据。
    *   **目标数据库查询**: 使用 MyBatis 执行动态构建或预定义的 SQL，连接到由动态数据源模块管理的目标数据库。利用 HikariCP 进行连接池管理。
*   **基础设施与横切关注点**: 
    *   **配置管理**: 集成 Spring Cloud Config Client，连接 Apollo/Consul 实现配置的集中化和动态刷新。
    *   **安全**: Spring Security 负责认证 (OAuth2.0/JWT) 和授权。
    *   **可靠性组件**: Resilience4J 用于实现重试、熔断、限流。
    *   **可观测性**: Micrometer 配合 Prometheus 进行指标收集，集成 OpenTelemetry/Sleuth 实现链路追踪，SLF4J + Logback/Log4j2 进行结构化日志记录。

## 4. 核心模块设计概要

设计细节参照《技术选型与架构建议》文档，此处简要重申核心思路：

### 4.1. 动态数据源管理模块
*   实现 `DataSourceRegistry` 服务，支持通过外部 API 或本地元数据加载数据源配置。
*   利用 Spring 的 `AbstractRoutingDataSource` 结合 `ThreadLocal` 实现运行时数据源动态切换。
*   每个数据源配置独立的 HikariCP 连接池。

### 4.2. SQL 查询服务模块
*   **内置静态 SQL**: 资源文件加载，持久化到元数据库，支持 API 动态修改和 `sqlCode` 唯一标识。
*   **批量执行**: API 支持多 `sqlCode` 并发/串行执行，结果统一 JSON 数组返回，含各 SQL 执行状态。
*   **扩展性**: 定义 `DynamicSqlProvider` SPI 接口，允许从脚本中心或配置中心加载动态 SQL。

### 4.3. API 接口设计
*   严格遵循 RESTful 规范，使用 OpenAPI 3.0 (Swagger UI) 进行文档化。
*   关键接口包括数据源管理、SQL 模板管理、SQL 执行接口等。

### 4.4. 可视化调试前端 (高阶规划)
*   采用 React 或 Vue.js，前后端分离架构。
*   功能：数据源参数配置、SQL 选择、参数输入、结果展示（表格/树形）。
*   通过调用后端 OpenAPI 与服务交互。

### 4.5. 外部 API 调用能力
*   封装 HTTP Client (推荐 Spring Cloud OpenFeign 或 WebClient)。
*   外部接口配置信息（URL、认证等）在元数据库中管理，支持 API 动态配置。

## 5. 非功能性需求实现策略概要

具体策略见《技术选型与架构建议》，核心包括：
*   **性能**: HikariCP, MyBatis SQL 调优, 异步处理, 缓存, 压力测试。
*   **可靠性**: 幂等设计, Spring Retry/Resilience4J (重试、熔断、限流)。
*   **安全**: HTTPS, Spring Security (OAuth2/JWT), Bean Validation, MyBatis `#{}` 防注入。
*   **扩展性**: 模块化, SPI, 配置中心 (Apollo/Consul)。
*   **可观测性**: Actuator + Micrometer (Prometheus), Grafana, OpenTelemetry/Sleuth (Zipkin/Jaeger), 结构化日志。
*   **测试**: JUnit5, Mockito, Spring Boot Test, Testcontainers。
*   **部署**: Docker, JAR, Actuator 健康检查。
*   **文档**: OpenAPI, 示例代码, FAQ, 错误码。

## 6. 开发计划与阶段里程碑

项目开发将分为若干阶段，每个阶段设定明确的里程碑。以下是一个初步的计划：

### 阶段一：核心后端基础构建 (预计 4-6 周)
*   **目标**: 完成数据源管理、SQL 服务核心功能的开发与单元/集成测试。
*   **里程碑 1.1**: **动态数据源管理实现**
    *   本地元数据查询方式的数据源接入与切换功能完成。
    *   通过第三方 API 获取数据源连接信息的功能完成。
    *   HikariCP 连接池集成与配置。
    *   相关管理 API (增删改查数据源配置) 初步完成。
    *   单元测试与集成测试覆盖。
*   **里程碑 1.2**: **静态 SQL 管理与单次执行实现**
    *   SQL 模板从资源文件加载并持久化到数据库功能完成。
    *   通过 `sqlCode` 查询并执行单条静态 SQL 的服务及 API 完成。
    *   MyBatis 与目标数据库的集成与查询验证。
    *   SQL 模板动态修改 API 初步完成。
    *   单元测试与集成测试覆盖。
*   **里程碑 1.3**: **批量 SQL 执行实现**
    *   支持单次请求并发执行多条 SQL 的服务及 API 完成。
    *   结果汇总与统一 JSON 格式返回。
    *   并发执行的线程池配置与管理。
    *   单元测试与集成测试覆盖。
*   **里程碑 1.4**: **基础 API 与文档**
    *   核心功能的 RESTful API 设计完成并通过 Springdoc OpenAPI 暴露。
    *   初步的 API 认证机制 (如简单的 API Key 或 JWT 存根) 集成。

### 阶段二：高级功能与前端原型 (预计 3-5 周)
*   **目标**: 实现 SQL 执行扩展性、外部 API 调用能力，并搭建可视化前端的基本框架。
*   **里程碑 2.1**: **SQL 执行扩展性 (SPI)**
    *   `DynamicSqlProvider` SPI 接口定义完成。
    *   至少一个 SPI 实现的 Proof-of-Concept (PoC)，例如从配置文件或简单脚本加载动态 SQL。
    *   查询服务逻辑调整以支持动态 SQL源。
*   **里程碑 2.2**: **外部 API 调用能力**
    *   封装通用 HTTP Client (Feign/WebClient) 完成。
    *   外部 API 配置管理（元数据存储与管理 API）完成。
    *   至少一个调用外部 API 的示例功能实现并测试。
*   **里程碑 2.3**: **可视化前端原型**
    *   前端技术选型确定 (React/Vue)。
    *   基础页面布局，能够调用后端 API 获取 SQL 模板列表。
    *   实现填写连接参数、选择 SQL、输入参数并调用后端执行接口、简单展示 JSON 返回结果的最小可行产品 (MVP)。

### 阶段三：非功能性需求强化与测试 (预计 4-6 周)
*   **目标**: 全面落实关键的非功能性需求，提升系统稳定性和可维护性，并达到测试覆盖率目标。
*   **里程碑 3.1**: **安全体系完善**
    *   HTTPS 部署配置完成。
    *   完整的 OAuth2.0/JWT 认证授权流程集成与测试。
    *   全面的参数校验与 SQL 注入防护措施审查与加固。
*   **里程碑 3.2**: **可靠性机制集成**
    *   针对关键外部调用和数据库操作，集成 Resilience4J 的重试和熔断器机制。
    *   核心 API 接口的限流措施配置与测试。
    *   关键写操作的幂等性设计验证。
*   **里程碑 3.3**: **可观测性系统搭建**
    *   Prometheus 指标导出配置完成，关键业务指标覆盖。
    *   Grafana 仪表盘初步搭建，展示核心监控数据。
    *   分布式链路追踪 (Zipkin/Jaeger) 集成，覆盖主要服务调用链路。
    *   结构化日志输出规范化，并验证日志收集（如 ELK/EFK 栈对接）。
*   **里程碑 3.4**: **测试覆盖率与质量保障**
    *   单元测试覆盖率达到 ≥ 80%。
    *   集成测试覆盖率达到 ≥ 70%。
    *   完成一轮针对核心功能的探索性测试和回归测试。

### 阶段四：部署、文档完善与优化 (预计 2-4 周)
*   **目标**: 完成生产环境的部署准备，完善所有相关文档，并根据测试结果进行性能优化。
*   **里程碑 4.1**: **部署方案验证**
    *   Dockerfile 编写与优化，实现容器化部署。
    *   JAR 包部署方式验证。
    *   健康检查探针 (`/actuator/health`) 功能完善与测试。
*   **里程碑 4.2**: **项目文档最终化**
    *   OpenAPI 文档审查与完善，确保准确性和易用性。
    *   提供清晰的 API 示例代码 (Postman 集合/curl)。
    *   编写并审查 FAQ 和常见错误码说明文档。
*   **里程碑 4.3**: **性能测试与调优**
    *   执行压力测试，验证系统是否满足 ≥ 500 QPS 的并发要求。
    *   针对 P95 响应时间 < 300ms 的目标进行瓶颈分析和优化。
*   **里程碑 4.4**: **用户验收与试运行 (UAT)**
    *   准备用户验收测试环境和测试用例。
    *   配合用户进行 UAT，收集反馈并修复问题。

## 7. 团队角色与职责 (占位)

（根据实际团队情况补充，例如：项目经理、架构师、后端开发工程师、前端开发工程师、测试工程师、运维工程师等及其职责。）

## 8. 风险评估与应对策略 (占位)

*   **技术风险**: 
    *   *风险点*: 对新技术栈（如 Java 17, Spring Boot 3.x, OceanBase）掌握不充分。
    *   *应对*: 安排前期技术预研和培训；引入外部专家咨询。
*   **需求变更风险**: 
    *   *风险点*: 项目过程中需求频繁变更导致范围蔓延。
    *   *应对*: 建立清晰的需求变更管理流程；敏捷迭代，小步快跑，及时反馈。
*   **第三方依赖风险**: 
    *   *风险点*: 外部数据源管理 API 不稳定或不符合预期。
    *   *应对*: 充分调研和测试第三方 API；设计好容错和降级方案。
*   **性能不达标风险**: 
    *   *风险点*: 系统在高并发下性能无法满足要求。
    *   *应对*: 早期进行性能建模和基准测试；持续性能监控和调优；采用成熟的高性能组件。

## 9. 总结

本初步设计方案与开发计划为项目的实施提供了蓝图。在项目执行过程中，将采用敏捷迭代的方式，定期回顾和调整计划，确保项目目标的达成。所有文档和设计细节将随着项目的进展持续更新和完善。

