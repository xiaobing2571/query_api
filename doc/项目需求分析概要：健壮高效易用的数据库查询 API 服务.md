# 项目需求分析概要：健壮高效易用的数据库查询 API 服务

## 一、项目核心目标与范围

本项目旨在构建一个高质量的后端 API 服务，其核心功能是为前端应用及其他后端系统提供统一、高效且支持多目标数据库的查询能力。该服务将采用 Java 语言及 Maven 构建体系，并强调元数据的持久化管理（通过 MySQL 或 OceanBase 实现）、对多种数据源的动态接入能力，以及完备的测试框架和可视化调试工具。

## 二、技术栈选型

项目明确指定了以下技术栈：
*   **后端核心**：采用 Java 17 或更高版本，结合 Spring Boot 3.x 框架进行开发。
*   **构建工具**：使用 Maven 进行项目构建和依赖管理。
*   **数据持久化**：持久层技术选型包括 MyBatis 或 Spring Data JPA。
*   **元数据存储**：选择 MySQL 或 OceanBase 数据库用于存储服务自身的元数据信息。
*   **前端交互**：推荐使用 React 或 Vue.js 构建前后端分离的调试与管理界面。
*   **测试体系**：单元测试将依赖 JUnit5 和 Mockito；集成测试则采用 Testcontainers 或 Spring Boot Test。
*   **API 文档与契约**：遵循 OpenAPI 3.0 规范，并利用 Swagger UI 提供交互式 API 文档。
*   **持续集成与部署 (CI/CD)**：考虑使用 GitHub Actions 或 Jenkins 实现自动化流程。

## 三、核心功能需求详解

### 1. 动态数据源管理

系统需具备灵活的数据源管理能力，支持动态接入不同的目标数据库。
*   **接入方式**：
    *   **外部 API 调用**：通过调用第三方数据源管理服务的 API，依据传入参数（例如数据源 ID、类型标识 `sourceType`、凭证密钥 `credentialsKey`）动态获取数据库连接详情。
    *   **本地元数据查询**：从项目自身的元数据库（MySQL/OceanBase）中，根据指定的数据源标识（如 `datasource_id`）查询并加载连接信息。
*   **自动切换与连接池**：系统应能根据上述不同的接入方式自动配置并切换数据源，同时必须集成并有效利用连接池技术（如 HikariCP）以提升性能和资源利用率。

### 2. SQL 查询服务

此模块是服务的核心，负责处理和执行 SQL 查询。
*   **内置静态 SQL 管理**：
    *   系统将预定义一批常用的 SQL 查询模板，这些模板初始时存储在项目的资源文件中。
    *   服务启动后，这些 SQL 模板将被加载并持久化到元数据库中，且后续应支持动态地在线修改或更新这些模板。
    *   每条 SQL 模板都将拥有一个全局唯一的标识符（`sqlCode`），方便调用和管理，并且系统应支持按需扩展，方便地新增 SQL 模板。
*   **批量 SQL 执行**：
    *   API 需支持在单次请求中指定多个 `sqlCode`，并为每个 `sqlCode` 附带其执行所需的参数列表。
    *   服务需要能够并发或按序执行这些 SQL 查询，并将所有查询的结果进行汇总后统一返回。
    *   返回结果的格式应为统一的 JSON 数组，数组中的每个元素对应一条 SQL 的执行情况，包含其执行结果数据以及执行状态（成功、失败、错误信息等）。
*   **SQL 执行扩展性**：
    *   系统应提供标准的接口或插件机制，以支持未来从外部系统（如脚本中心、配置中心）动态加载和执行 SQL 查询，增强服务的灵活性和适应性。

### 3. API 接口设计规范

所有对外暴露的 API 接口设计必须严格遵循 RESTful 架构风格和原则，确保接口的规范性、易用性和可理解性。

### 4. 可视化调试前端

为了方便开发和测试，项目需要提供一个简易的可视化前端调试页面。
*   **核心功能**：该页面应支持用户填写数据源连接方式的参数，选择要执行的 SQL 模板（`sqlCode`），输入该 SQL 所需的参数，并能清晰地查看后端返回的 JSON 结果。
*   **技术实现**：前端应与后端服务完全分离，通过调用后端暴露的 OpenAPI 接口获取数据。前端需具备将返回的 JSON 数据实时渲染成表格或树形视图的能力，以便于结果的直观展示和分析。

### 5. 外部 API 调用能力

服务自身也需要具备调用其他外部 REST API 的能力。
*   **HTTP 客户端封装**：系统内部应封装一个通用的 HTTP Client，可考虑使用成熟的库或框架，如基于 Swagger 生成的 SDK、Feign 声明式客户端，或者 Spring 框架提供的 RestTemplate/WebClient。
*   **外部接口配置管理**：提供相应的机制来注册和管理这些外部接口的配置信息（如 URL、认证方式等），以保证这部分功能的可扩展性和可维护性。

## 四、关键非功能性需求

除了核心功能外，项目对服务的性能、可靠性、安全等非功能性方面也有明确要求。

*   **性能要求**：
    *   对于单条 SQL 查询，P95 响应时间必须控制在 300毫秒以内。
    *   系统需要支持至少 500 QPS（每秒查询数）的并发处理能力。
*   **可靠性保障**：
    *   关键操作需进行幂等性设计，防止重复操作导致意外结果。
    *   实现失败重试机制，对于幂等操作，其重试次数应支持可配置。
    *   集成熔断机制（如 Hystrix、Resilience4J）和限流措施，以保护服务在高负载或下游故障时的稳定性。
*   **安全规范**：
    *   所有 API 通信必须使用 HTTPS 进行加密。
    *   应集成 OAuth2.0 或 JWT 等认证授权机制来保护 API 接口。
    *   必须进行严格的参数校验，并采取有效措施防范 SQL 注入等安全风险。
*   **系统扩展性**：
    *   整体架构需采用模块化设计，降低各模块间的耦合度。
    *   积极引入 SPI（Service Provider Interface）或插件机制，方便未来功能的扩展。
    *   考虑与配置中心（如 Apollo、Consul）集成，实现配置的动态管理。
*   **可观测性建设**：
    *   服务应能导出符合 Prometheus 格式的监控指标。
    *   提供配套的 Grafana 仪表盘配置，用于监控数据的可视化展示。
    *   集成分布式链路追踪系统（如 Zipkin、Jaeger），方便问题排查和性能分析。
    *   采用结构化日志输出，便于日志的收集、查询和分析。
*   **测试覆盖率**：
    *   单元测试覆盖率要求不低于 80%。
    *   集成测试覆盖率要求不低于 70%。
*   **部署与运维**：
    *   服务需支持通过 DOCKER 容器化部署，同时也应支持传统的 JAR 包方式部署。
    *   必须提供标准的健康检查探针接口，便于监控系统进行存活和就绪状态的检查。
*   **项目文档**：
    *   提供完整且详细的 OpenAPI 文档。
    *   包含清晰的示例代码，帮助开发者快速上手。
    *   整理 FAQ（常见问题解答）以及常见错误码说明，方便用户排查问题。

